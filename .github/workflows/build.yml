name: Build project artifacts & containers

on:
  workflow_dispatch:
  push:

jobs:
  buildContainers:
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/master' &&
      github.repository == 'MahjongPantheon/pantheon'
    steps:
      - uses: actions/checkout@v2
      - uses: webgtx/setup-podman-compose@v1

      - name: Log in to container registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | podman login -u "${{ github.repository_owner }}" --password-stdin ghcr.io

      - name: Build and push [Backend common]
        run: |
          cd ./Common/Backend && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-backend-common-v3-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-backend-common-v3-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-backend-common-v3-amd64:latest; fi

      - name: Build and push [Frontend common]
        run: |
          cd ./Common/Frontend && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-frontend-common-v3-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-frontend-common-v3-amd64-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-frontend-common-v3-amd64:latest; fi

      - name: Build and push [Database]
        run: |
          cd ./Database && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-database-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-database-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-database-amd64:latest; fi

      - name: Build and push [Forseti]
        run: |
          cd ./Forseti && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-forseti-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-forseti-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-forseti-amd64:latest; fi

      - name: Build and push [Frey]
        run: |
          cd ./Frey && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-frey-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-frey-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-frey-amd64:latest; fi

      - name: Build and push [Hermod]
        run: |
          cd ./Hermod && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-hermod-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-hermod-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-hermod-amd64:latest; fi

      - name: Build and push [Hugin]
        run: |
          cd ./Hugin && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-hugin-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-hugin-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-hugin-amd64:latest; fi

      - name: Build and push [Gullveig]
        run: |
          cd ./Gullveig && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-gullveig-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-gullveig-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-gullveig-amd64:latest; fi

      - name: Build and push [Mimir]
        run: |
          cd ./Mimir && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-mimir-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-mimir-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-mimir-amd64:latest; fi

      - name: Build and push [Sigrun]
        run: |
          cd ./Sigrun && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-sigrun-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-sigrun-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-sigrun-amd64:latest; fi

      - name: Build and push [Bragi]
        run: |
          cd ./Bragi && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-bragi-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-bragi-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-bragi-amd64:latest; fi

      - name: Build and push [Skirnir]
        run: |
          cd ./Skirnir && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-skirnir-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-skirnir-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-skirnir-amd64:latest; fi

      - name: Build and push [Tyr]
        run: |
          cd ./Tyr && podman build --format docker --platform linux/amd64 \
            -t ghcr.io/mahjongpantheon/pantheon-tyr-amd64:latest \
            -t ghcr.io/mahjongpantheon/pantheon-tyr-amd64:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-tyr-amd64:latest; fi
