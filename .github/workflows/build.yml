name: Build project artifacts & containers

on:
  workflow_dispatch:
  push:

jobs:
  buildContainers:
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/master' &&
      github.repository == 'MahjongPantheon/pantheon'
    steps:
      - uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Log in to container registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | podman login -u "${{ github.repository_owner }}" --password-stdin ghcr.io

      - name: Build and push [Backend common]
        run: |
          cd ./Common/Backend && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-backend-common-v3:latest \
            -t ghcr.io/mahjongpantheon/pantheon-backend-common-v3:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-backend-common-v3:latest; fi

      - name: Build and push [Frontend common]
        run: |
          cd ./Common/Frontend && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-frontend-common-v3:latest \
            -t ghcr.io/mahjongpantheon/pantheon-frontend-common-v3:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-frontend-common-v3:latest; fi

      - name: Build and push [Database]
        run: |
          cd ./Database && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-database:latest \
            -t ghcr.io/mahjongpantheon/pantheon-database:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-database:latest; fi

      - name: Build and push [Forseti]
        run: |
          cd ./Forseti && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-forseti:latest \
            -t ghcr.io/mahjongpantheon/pantheon-forseti:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-forseti:latest; fi

      - name: Build and push [Frey]
        run: |
          cd ./Frey && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-frey:latest \
            -t ghcr.io/mahjongpantheon/pantheon-frey:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-frey:latest; fi

      - name: Build and push [Hermod]
        run: |
          cd ./Hermod && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-hermod:latest \
            -t ghcr.io/mahjongpantheon/pantheon-hermod:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-hermod:latest; fi

      - name: Build and push [Hugin]
        run: |
          cd ./Hugin && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-hugin:latest \
            -t ghcr.io/mahjongpantheon/pantheon-hugin:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-hugin:latest; fi

      - name: Build and push [Gullveig]
        run: |
          cd ./Gullveig && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-gullveig:latest \
            -t ghcr.io/mahjongpantheon/pantheon-gullveig:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-gullveig:latest; fi

      - name: Build and push [Mimir]
        run: |
          cd ./Mimir && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-mimir:latest \
            -t ghcr.io/mahjongpantheon/pantheon-mimir:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-mimir:latest; fi

      - name: Build and push [Sigrun]
        run: |
          cd ./Sigrun && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-sigrun:latest \
            -t ghcr.io/mahjongpantheon/pantheon-sigrun:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-sigrun:latest; fi

      - name: Build and push [Bragi]
        run: |
          cd ./Bragi && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-bragi:latest \
            -t ghcr.io/mahjongpantheon/pantheon-bragi:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-bragi:latest; fi

      - name: Build and push [Skirnir]
        run: |
          cd ./Skirnir && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-skirnir:latest \
            -t ghcr.io/mahjongpantheon/pantheon-skirnir:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-skirnir:latest; fi

      - name: Build and push [Fenrir]
        run: |
          cd ./Fenrir && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-fenrir:latest \
            -t ghcr.io/mahjongpantheon/pantheon-fenrir:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-fenrir:latest; fi

      - name: Build and push [Tyr]
        run: |
          cd ./Tyr && podman build --format docker --platform linux/amd64,linux/arm64 \
            -t ghcr.io/mahjongpantheon/pantheon-tyr:latest \
            -t ghcr.io/mahjongpantheon/pantheon-tyr:${{ github.sha }} \
          .
          if [ "${{ github.event_name }}" != "pull_request" ]; then podman push ghcr.io/mahjongpantheon/pantheon-tyr:latest; fi
