upstream sigrunnode {
  keepalive 24;
  least_conn;
  server localhost:41021 max_fails=3 fail_timeout=5s;
  server localhost:41022 max_fails=3 fail_timeout=5s;
  server localhost:41023 max_fails=3 fail_timeout=5s;
  server localhost:41024 max_fails=3 fail_timeout=5s;
  server localhost:41025 max_fails=3 fail_timeout=5s;
  server localhost:41026 max_fails=3 fail_timeout=5s;
  server localhost:41027 max_fails=3 fail_timeout=5s;
  server localhost:41028 max_fails=3 fail_timeout=5s;
}

server {
  listen 80;
  server_name sigrun.pantheon.local;

  location / {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_pass http://localhost:4002;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

  location ~ /\.ht {
    deny all;
  }

  error_page 500 502 503 504    /50x.html;
  location = /50x.html {
    root html;
  }
}

server {
  listen 80;
  server_name sigrun.pantheon.internal;

  location ^~ /.well-known/acme-challenge/ {
  	default_type "text/plain";
  	root /var/www/html/Sigrun-dist;
  }

  location /assets/ {
    root /var/www/html/Sigrun-dist/dist/client;
  }

  location / {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_pass http://sigrunnode;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

  location = /sw.js {
    root /var/www/html/Sigrun-dist/dist/client;
    add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
    expires -1;
  }

  location ~* \.webmanifest$ {
    root /var/www/html/Sigrun-dist/dist/client;
    add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
    expires -1;
    types { } default_type "application/manifest+json; charset=utf-8";
  }

  location = /pwa-192x192.png {
    root /var/www/html/Sigrun-dist/dist/client;
  }

  location = /pwa-512x512.png {
    root /var/www/html/Sigrun-dist/dist/client;
  }

  location ~ /\.ht {
    deny all;
  }

  error_page 500 502 503 504    /50x.html;
  location = /50x.html {
    root html;
  }
}
